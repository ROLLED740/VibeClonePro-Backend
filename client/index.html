<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeClonePro Test Client</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-top: 30px; }
        .section { margin-bottom: 20px; padding: 15px; background: #fafafa; border: 1px solid #ddd; border-radius: 4px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, button { margin-bottom: 10px; padding: 8px; width: 100%; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        #logs { background: #333; color: #0f0; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; border-radius: 4px; }
        .response { background: #eef; padding: 10px; margin-top: 5px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>

<div class="container">
    <h1>VibeClonePro Test Client</h1>

    <!-- User Section -->
    <div class="section">
        <h2>1. Create User</h2>
        <label>Email:</label>
        <input type="email" id="userEmail" value="test@example.com">
        <label>Password:</label>
        <input type="password" id="userPass" value="password123">
        <button onclick="createUser()">Create User</button>
        <div id="userResponse" class="response"></div>
    </div>

    <!-- Vault Section -->
    <div class="section">
        <h2>2. Store Secret (The Vault)</h2>
        <label>Owner ID (from above):</label>
        <input type="text" id="vaultOwnerId" placeholder="Paste User ID here">
        <label>Secret Name:</label>
        <input type="text" id="secretName" value="API Key">
        <label>Content (Expected to be encrypted):</label>
        <input type="text" id="secretContent" value="sk-live-123456789">
        <button onclick="storeSecret()">Encrypt & Store</button>
        <div id="vaultStoreResponse" class="response"></div>
    </div>

    <div class="section">
        <h2>3. Reveal Secret</h2>
        <label>Secret ID:</label>
        <input type="text" id="secretId" placeholder="Paste Secret ID here">
        <button onclick="revealSecret()">Decrypt & Reveal</button>
        <div id="vaultRevealResponse" class="response"></div>
    </div>

    <!-- Telemetry Section -->
    <div class="section">
        <h2>4. Live Telemetry (Socket.io)</h2>
        <p>Status: <span id="socketStatus" style="color:red">Disconnected</span></p>
        <div id="logs"></div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:3000';
    let socket;

    // --- WebSocket / Telemetry ---
    function initSocket() {
        socket = io(API_URL);

        socket.on('connect', () => {
            document.getElementById('socketStatus').innerText = 'Connected';
            document.getElementById('socketStatus').style.color = 'green';
            log('WebSocket connected: ' + socket.id);
        });

        socket.on('disconnect', () => {
            document.getElementById('socketStatus').innerText = 'Disconnected';
            document.getElementById('socketStatus').style.color = 'red';
            log('WebSocket disconnected');
        });

        socket.on('status', (data) => {
            log('Status Update: ' + JSON.stringify(data));
        });

        socket.on('buildUpdate', (data) => {
            log('Build Update: ' + JSON.stringify(data));
        });

        socket.on('systemVitals', (data) => {
            log('System Vitals: CPU ' + data.cpu + '%, Mem ' + data.memory + '%');
        });
    }

    function log(msg) {
        const logs = document.getElementById('logs');
        const div = document.createElement('div');
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    // --- REST API Calls ---

    async function createUser() {
        const email = document.getElementById('userEmail').value;
        const password = document.getElementById('userPass').value;
        
        try {
            const res = await fetch(`${API_URL}/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            document.getElementById('userResponse').innerText = JSON.stringify(data, null, 2);
            if (data.id) {
                document.getElementById('vaultOwnerId').value = data.id; // Auto-fill
                log('User created: ' + data.id);
            }
        } catch (e) {
            document.getElementById('userResponse').innerText = 'Error: ' + e.message;
        }
    }

    async function storeSecret() {
        const ownerId = document.getElementById('vaultOwnerId').value;
        const name = document.getElementById('secretName').value;
        const content = document.getElementById('secretContent').value;

        try {
            const res = await fetch(`${API_URL}/vault`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, content, ownerId })
            });
            const data = await res.json();
            document.getElementById('vaultStoreResponse').innerText = JSON.stringify(data, null, 2);
            if (data.id) {
                document.getElementById('secretId').value = data.id; // Auto-fill
                log('Secret stored (Encrypted): ' + data.encryptedContent.substring(0, 10) + '...');
            }
        } catch (e) {
            document.getElementById('vaultStoreResponse').innerText = 'Error: ' + e.message;
        }
    }

    async function revealSecret() {
        const id = document.getElementById('secretId').value;
        try {
            const res = await fetch(`${API_URL}/vault/${id}/reveal`);
            const text = await res.text(); // Endpoint returns string
            document.getElementById('vaultRevealResponse').innerText = "Decrypted Content: " + text;
            log('Secret revealed');
        } catch (e) {
            document.getElementById('vaultRevealResponse').innerText = 'Error: ' + e.message;
        }
    }

    // Start
    initSocket();

</script>

</body>
</html>
